name: Build Viewer to gh-pages

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3

      - name: Create _site directory and download character data
        run: |
          mkdir -p _site
          curl -o _site/character.json https://api.hakush.in/ww//data/character.json

      - name: Generate index.json files
        run: |
          find . -mindepth 1 -maxdepth 1 -type d | while read dir; do
            cd "$dir"
            files=$(ls | grep -Ei '\.(png|jpe?g|webp|gif)$' | jq -R -s -c 'split("\n")[:-1]')
            echo "$files" > index.json
            cd ..
          done

      - name: Get folders
        id: get_folders
        run: |
          folders=$(ls -d [0-9]*/ 2>/dev/null | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "::set-output name=folders::$folders"

      - name: Create static viewer to _site
        run: |
          mkdir -p _site/js

          # index.html
          cat > _site/index.html <<EOF
          <!DOCTYPE html>
          <html lang="zh">
          <head>
            <meta charset="UTF-8">
            <title>å›¾ç‰‡æ–‡ä»¶å¤¹åˆ—è¡¨</title>
            <link rel="stylesheet" href="style.css">
          </head>
          <body>
            <h1>ğŸ“ å›¾ç‰‡æµè§ˆå™¨</h1>
            <ul id="folder-list"></ul>
            <script>
              // ä»æœ¬åœ°è¯»å–è§’è‰²æ•°æ®
              fetch('character.json')
                .then(r => r.json())
                .then(charData => {
                  const folders = JSON.parse('${{ steps.get_folders.outputs.folders }}');
                  const baseUrl = "viewer.html?folder=";
                  const list = document.getElementById("folder-list");
                  
                  folders.forEach(f => {
                    const folderId = f.replace("/", "");
                    const charInfo = charData[folderId];
                    
                    if(charInfo) {
                      const li = document.createElement("li");
                      li.innerHTML = \`<a href="\${baseUrl}\${folderId}">\${charInfo['zh-Hans']} (\${folderId})</a>\`;
                      list.appendChild(li);
                    }
                  });
                })
                .catch(err => {
                  console.error('è¯»å–è§’è‰²æ•°æ®å¤±è´¥:', err);
                  const folders = JSON.parse('${{ steps.get_folders.outputs.folders }}');
                  const baseUrl = "viewer.html?folder=";
                  const list = document.getElementById("folder-list");
                  
                  folders.forEach(f => {
                    const name = f.replace("/", "");
                    const li = document.createElement("li");
                    li.innerHTML = \`<a href="\${baseUrl}\${name}">ğŸ“ \${name}</a>\`;
                    list.appendChild(li);
                  });
                });
            </script>
          </body>
          </html>
          EOF

          # viewer.html ä¿®æ”¹
          cat > _site/viewer.html <<EOF
          <!DOCTYPE html>
          <html lang="zh">
          <head>
            <meta charset="UTF-8">
            <title>å›¾ç‰‡å±•ç¤º</title>
            <link rel="stylesheet" href="style.css">
          </head>
          <body>
            <a href="index.html">è¿”å›ä¸»é¡µ</a>
            <h1 id="title">Loading...</h1>
            <div id="gallery"></div>
            <script>
              const params = new URLSearchParams(location.search);
              const folder = params.get("folder");
              
              // ä»æœ¬åœ°è¯»å–è§’è‰²æ•°æ®
              fetch('character.json')
                .then(r => r.json())
                .then(charData => {
                  const charInfo = charData[folder];
                  if(charInfo) {
                    document.getElementById("title").innerText = \`ğŸ“ \${charInfo['zh-Hans']}\`;
                  } else {
                    document.getElementById("title").innerText = \`ğŸ“ \${folder}\`;
                  }
                })
                .catch(() => {
                  document.getElementById("title").innerText = \`ğŸ“ \${folder}\`;
                });
            </script>
            <script src="js/render.js"></script>
          </body>
          </html>
          EOF

          # render.js
          cat > _site/js/render.js <<EOF
          const params = new URLSearchParams(location.search);
          const folder = params.get("folder");
          document.getElementById("title").innerText = \`ğŸ“ \${folder}\`;
          const gallery = document.getElementById("gallery");

          const base = \`https://raw.githubusercontent.com/\${location.hostname.split('.')[0]}/\${location.pathname.split('/')[1]}/gh-pages/\${folder}/\`;

          fetch(\`\${base}index.json\`)
            .then(r => r.json())
            .then(images => {
              images.forEach(img => {
                const el = document.createElement("img");
                el.src = base + img;
                el.alt = img;
                el.style = "max-width:200px;margin:10px;border:1px solid #ccc;";
                gallery.appendChild(el);
              });
            });
          EOF

          # style.css
          cat > _site/style.css <<EOF
          body {
            font-family: sans-serif;
            padding: 20px;
            background: #f2f2f2;
          }
          img {
            max-width: 200px;
            margin: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
          }
          EOF

      - name: Copy image folders to _site
        run: |
          for dir in [0-9][0-9]*/; do
            cp -r "$dir" _site/
          done

      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          publish_branch: gh-pages
